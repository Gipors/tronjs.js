var AC="ADODB.CONNECTION";var connect=new Class(function(B,C){this.object=new ActiveXObject(AC);this.connectString=[];if(B==="access"){this.Access(C)}else{if(B==="mssql"){this.MsSql(C)}}for(var A=0;A<this.connectString.length;A++){try{this.object.Open(this.connectString[A]);break}catch(D){}}return this.object});connect.add("Access",function(A){this.connectString=["provider=Microsoft.jet.oledb.4.0;data source="+A,"driver={microsoft access driver (*.mdb)};dbq="+A]});connect.add("MsSql",function(A){var B=[];B.push(["Provider=sqloledb","Data Source="+A.netserver,"Initial Catalog="+A.access,"User Id="+A.username,"Password="+A.password,""].join(";"));B.push(["Driver={SQL Server}","Server="+A.netserver,"Database="+A.access,"Uid="+A.username,"Pwd="+A.password,""].join(";"));this.connectString=B});var AR="ADODB.RECORDSET";var DBOMAPS={};var dbo=new Class(function(A,B){if(DBOMAPS[A]){return DBOMAPS[A]}this.table=A;this.conn=B;this.object=new ActiveXObject(AR);this.fields=[];this.length=0;this.resetSQL();new where(this);DBOMAPS[A]=this});dbo.add("GetFields",function(){this.object.Open("SELECT TOP 0 * FROM "+this.table,this.conn,1,1);for(var A=0;A<this.object.fields.count;A++){this.fields.push(this.object.fields(A).name)}this.length=this.fields.length;this.object.Close();return this});dbo.add("create",function(){this.object.AddNew();return this});dbo.add("set",function(A,B){if(!B&&typeof A==="object"){for(var C in A){this.object(C)=A[C]}}else{this.object(A)=B}return this});dbo.add("save",function(){this.object.Update();return this});dbo.add("remove",function(){this.object.Delete();return this});dbo.add("top",function(A){if(A&&!isNaN(A)){this.sql.top=A}return this});dbo.add("selectAll",function(){this.sql.selectors=["*"];return this});dbo.add("select",function(){if(!this.sql.selectors){this.sql.selectors=[]}var A=Array.prototype.slice.call(arguments,0);this.sql.selectors=unique(this.sql.selectors.concat(A));return this});dbo.add("where",function(A){this.sql.where=A;return this});dbo.add("asc",function(A){if(!this.sql.order||this.sql.order.length===0){this.sql.order=[]}this.sql.order.push(A+" ASC");return this});dbo.add("desc",function(A){if(!this.sql.order||this.sql.order.length===0){this.sql.order=[]}this.sql.order.push(A+" DESC");return this});dbo.add("resetSQL",function(){this.sql={};this.sql.where="";return this});dbo.add("gruntSQL",function(){var A=["SELECT"];if(this.sql.top&&this.sql.top>0){A.push("TOP "+this.sql.top)}if(this.sql.selectors&&this.sql.selectors.length>0){A.push(this.sql.selectors.join(","))}A.push("FROM "+this.table);if(this.sql.where.length>0){A.push("WHERE");A.push(this.sql.where)}if(this.sql.order&&this.sql.order.length>0){A.push("ORDER BY");A.push(this.sql.order.join(","))}this.sql.text=A.join(" ");return this});dbo.add("open",function(A){this.gruntSQL();this.object.Open(this.sql.text,this.conn,1,A?A:1);return this});dbo.add("close",function(){try{this.object.Close()}catch(A){}return this});dbo.add("exec",function(A,B){if(!B&&readVariableType(A,"string")){this.conn.Execute(A)}else{if(!A){this.gruntSQL();this.conn.Execute(this.sql.text)}else{if(!this.object.Bof&&!this.object.Eof){typeof A==="function"&&A.call(this,this.object)}else{typeof B==="function"&&B.call(this,this.object)}}}return this});dbo.add("find",function(B,A){this.open(A).exec(function(C){B.call(this,this.object)});this.object.Close();return this});dbo.add("each",function(A){return this.exec(function(B){var C=0;B.MoveFirst();while(!B.Eof){typeof A==="function"&&A.call(this,B,C);B.MoveNext();C++}})});dbo.add("rows",function(){try{var A=this.object.GetRows().toArray();return getRows(A,this.object.Fields.Count)}catch(B){return[]}});var where=new Class(function(A){A.and=function(D,C,B){if(this.sql.where.length===0){this.sql.where+=GruntKeyValue(D,C,B)}else{this.sql.where+=" AND "+GruntKeyValue(D,C,B)}return this};A.or=function(D,C,B){if(this.sql.where.length===0){this.sql.where+=GruntKeyValue(D,C,B)}else{this.sql.where+=" OR "+GruntKeyValue(D,C,B)}return this};A.ands=function(C){var B=new (new Class(function(){this.sql={};this.sql.where=""}));new where(B);C.call(B);if(this.sql.where.length===0){this.sql.where+="("+B.sql.where+")"}else{this.sql.where+=" AND ("+B.sql.where+")"}return this};A.ors=function(C){var B=new (new Class(function(){this.sql={};this.sql.where=""}));new where(B);C.call(B);if(this.sql.where.length===0){this.sql.where+="("+B.sql.where+")"}else{this.sql.where+=" OR ("+B.sql.where+")"}return this}});function unique(B){var F={};var C=[];for(var D=0,A=B.length;D<A;D++){var E=B[D];if(F[E]!==1){F[E]=1;C.push(E)}}return C}function GruntKeyValue(C,B,A){if(!A){A="="}A=A.toLowerCase();if(A==="in"){if(!readVariableType(B,"array")){B=[B]}var D=[];for(var E=0;E<B.length;E++){if(readVariableType(B[E],"string")){D.push("'"+B[E]+"'")}else{D.push(B[E])}}return C+" IN ("+D.join(",")+")"}else{if(readVariableType(B,"string")){B="'"+B+"'"}return C+A+B}}function proxy(A,B){return function(){var C=arguments;return A.apply(B,C)}}function getRows(B,C){var A=B.length/C,G=[],F;for(var D=0;D<A;D++){G[D]=new Array();F=D*C;for(var E=0;E<C;E++){G[D][E]=B[F+E]}}return G}exports.connect=connect;exports.dbo=dbo;